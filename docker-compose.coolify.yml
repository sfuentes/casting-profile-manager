# Coolify Production Deployment
#
# HOW TO USE IN COOLIFY:
#   1. Create a new "Docker Compose" resource in Coolify
#   2. Point it at this repository and select this file as the compose file
#   3. Set the required environment variables in the Coolify UI (see .env.coolify.example)
#   4. Coolify will handle SSL termination via its built-in Traefik proxy
#
# PORTS:
#   - Frontend (Nginx):  exposed on SERVICE_FQDN_FRONTEND (your app domain)
#   - Backend API:       exposed on SERVICE_FQDN_BACKEND  (your API subdomain)
#   - MongoDB:           internal only (not exposed publicly)
#
# IMPORTANT: VITE_API_URL must be your public API URL (e.g. https://api.yourdomain.com/api)
#            because it is compiled into the frontend bundle at build time.
#
# REQUIRED ENV VARS (must be set in Coolify):
#   - MONGO_ROOT_PASSWORD (no default - will fail without it)
#   - JWT_SECRET (defaults to weak value - MUST CHANGE)
#   - VITE_API_URL (no default - frontend will break without it)
#   - FRONTEND_URL (no default - CORS will break without it)

services:
  # ─── MongoDB ────────────────────────────────────────────────────────────────
  mongodb:
    image: mongo:7.0
    # Only pull if the image is not already cached on the host.
    # This avoids Docker Hub anonymous rate-limit errors (100 pulls/6 h per IP)
    # on Hetzner/Coolify servers.  On a brand-new server, run once on the host:
    #   docker pull mongo:7.0
    # or configure Docker Hub credentials in Coolify → Settings → Registries.
    pull_policy: if_not_present
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      # CRITICAL: MONGO_ROOT_PASSWORD must be set in Coolify env vars
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:?MONGO_ROOT_PASSWORD must be set in Coolify environment variables}
      MONGO_INITDB_DATABASE: darsteller-manager
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
      - ./docker/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      - casting-network
    healthcheck:
      # Test with credentials so the healthcheck only passes once MongoDB is
      # actually accepting authenticated connections (not just responding to ping).
      # This prevents the backend from starting before auth is fully initialised.
      # $$ escapes the $ so Docker Compose does NOT interpolate at parse time;
      # the running container's shell expands them as $MONGO_INITDB_ROOT_* instead.
      test: ["CMD-SHELL", "mongosh --username \"$$MONGO_INITDB_ROOT_USERNAME\" --password \"$$MONGO_INITDB_ROOT_PASSWORD\" --authenticationDatabase admin --eval 'quit(db.adminCommand({ping:1}).ok ? 0 : 2)' --quiet"]
      interval: 20s
      timeout: 15s
      retries: 5
      start_period: 180s  # Increased from 120s for slower Coolify servers

  # ─── Backend API ─────────────────────────────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 5000
      # Pass MongoDB credentials individually so the backend can safely
      # URL-encode them (openssl rand -base64 passwords contain / + = which
      # break a pre-assembled URI string).  The URI is built in database.js.
      MONGO_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:?MONGO_ROOT_PASSWORD required}
      MONGO_HOST: mongodb
      MONGO_DB: darsteller-manager
      # CRITICAL: JWT_SECRET must be strong - generate with: openssl rand -hex 64
      JWT_SECRET: ${JWT_SECRET:-CHANGE_ME_INSECURE_DEFAULT_$(openssl rand -hex 32 2>/dev/null || echo PLEASE_SET_JWT_SECRET)}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      JWT_COOKIE_EXPIRE: ${JWT_COOKIE_EXPIRE:-7}
      # CRITICAL: Set this to your public frontend domain for CORS
      # Example: https://app.yourdomain.com (no trailing slash)
      FRONTEND_URL: ${FRONTEND_URL:?FRONTEND_URL must be set in Coolify environment variables}
      UPLOAD_DIR: ./uploads
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-10}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-600000}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}
      PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium-browser
    volumes:
      - backend_uploads:/app/uploads
      - backend_logs:/app/logs
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - casting-network
    expose:
      - "5000"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 5s  # Increased from 3s for slower servers
      retries: 5   # Increased from 3 for more reliability
      start_period: 60s  # Increased from 40s to allow MongoDB connection time

  # ─── Frontend (React → Nginx) ────────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # CRITICAL: This URL is baked into the JS bundle at build time by Vite.
        # It must be the publicly reachable URL of the backend API.
        # Example: https://api.yourdomain.com/api (must include /api)
        VITE_API_URL: ${VITE_API_URL:?VITE_API_URL must be set in Coolify environment variables}
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - casting-network
    expose:
      - "80"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  backend_uploads:
    driver: local
  backend_logs:
    driver: local

networks:
  casting-network:
    driver: bridge
